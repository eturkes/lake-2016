---
title:               "Lake 2016 snRNAseq Report"
author:
  - name:            "Emir Turkes"
  - name:            "Columbia University"
date:                '`r strftime(Sys.time(), format = "%B %d, %Y")`'
bibliography:        "../lake-2016-snRNAseq.bib"
biblio-style:        apalike
link-citations:      true
output:
  html_document:
    number_sections: true
    theme:           lumen
    toc:             true
    toc_depth:       2
    toc_float:
      collapsed:     false
      smooth_scroll: false

knit:
  (function(inputFile, encoding) {rmarkdown::render(
    inputFile,
    encoding = encoding,
    output_file = "../results/lake-2016-snRNAseq-report.html"
  )})
---

```{r, include = FALSE}
#    This file is part of lake-2016-snRNAseq.
#    Copyright (C) 2019  Emir Turkes
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
#    Emir Turkes can be contacted at emir.turkes@eturkes.com

knitr::opts_chunk$set(echo = TRUE)
```

<style type="text/css">

body{ /* Normal  */
  font-size: 16px;
}
h1.title {
  font-size: 35px;
}
h1 { /* Header 1 */
  font-size: 24px;
}
h2 { /* Header 2 */
  font-size: 22px;
}
h3 { /* Header 3 */
  font-size: 20px;
}
.toc-content {
  padding-left: 0px;
  padding-right: 0px;
}
div.tocify {
  width: 100%;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
  padding-left: 25px;
  text-indent: 0;
}
.tocify-subheader .tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 35px;
  text-indent: 0;
}
div.main-container {
  max-width: none;
  width: 100%;
}

</style>

*This is a broad initial analysis that prepares and characterizes the data for use in other projects.*

The background for this data is as follows:

- dbGaP Accession: [phs000833](https://www.ncbi.nlm.nih.gov/projects/gap/cgi-bin/study.cgi?study_id=phs000833.v7.p1).
- Part of [SCAP-T](https://www.scap-t.org/) and originally published in @lake_neuronal_2016.
- Single patient, age = 51, sex = female, NeuN + nuclei from normal mostmortem.
- 6 cortical regions: BA8, BA10, BA21, BA22, BA41, and BA17.
- Annotated into 8 excitatory and inhibitory neuronal subtypes.

This analysis was performed in R except where noted.
The source code and instructions for rerunning the analysis can be found at [github.com/eturkes/lake-2016-snRNAseq](https://github.com/eturkes/lake-2016-snRNAseq).

# Final Results

**Read just this section for the final results of the analysis and a summary of the methods.**

# ~~~~ Breakdown of Methods ~~~~ {-}

The following sections breakdown the methods used to transform the contents in `Original Data` to those in `Final Results`.

# Original Data

# To Be Organized

```{r}
# cc_tree <- data.tree::Node$new("cc_tree")
#   c1 <- cc_tree$AddChild("c1")
#     c1_c1 <- c1$AddChild("c1")
#       c1_c1_c1 <- c1_c1$AddChild("c1")
#       c1_c1_c2 <- c1_c1$AddChild("c2")
#     c1_c2 <- c1$AddChild("c2")
#       c1_c2_c1 <- c1_c2$AddChild("c1")
#       c1_c2_c2 <- c1_c2$AddChild("c2")
#   c2 <- cc_tree$AddChild("c2")
#     c2_c1 <- c2$AddChild("c1")
#       c2_c1_c1 <- c2_c1$AddChild("c1")
#       c2_c1_c2 <- c2_c1$AddChild("c2")
#     c2_c2 <- c2$AddChild("c2")
#       c2_c2_c1 <- c2_c2$AddChild("c1")
#       c2_c2_c2 <- c2_c2$AddChild("c2")
# 
# make_tree <- function(levels, children, prefix) {
#   parent_str <- paste(prefix, "tree", sep = "_")
#   assign(parent_str, data.tree::Node$new(parent_str))
#   
#   for (level in 1:levels) {
#     
#   }
#   
#   # for (level in 1:levels) {
#   #   num_parents <- (children ^ level) / children
#   #   parents <- vector(mode = "character", lenght = num_parents)
#   # 
#   #   if (level > 1) {
#   #     base_parent <- vector(mode = "character", length = 1)
#   #     for (position in 1:num_parents) {
#   #       for (sublevel in 1:level) {
#   #         base_parent <- paste(base_parent, )
#   #     }
#   #   }
#   #   for (parent in 1:parents) {
#   #     for (child in 1:children) {
#   #       assign(paste0(prefix, child), paste0(parent_str, "$AddChild"))
#   #     }
#   #   }
#   # }
# }
x1 <- read.delim(
  "../data/Lake-2016_Gene_TPM.dat",
  "\t", header=F, stringsAsFactors=FALSE
)
ann <- read.table(
  "../data/Lake-2016_Gene_TPM_Sample-annotation.txt",
  header=T
)
gene_names <- x1[,1]
cell_names <- x1[1,]
cell_names <- as.character(unlist(cell_names))
cell_names <- cell_names[-1]
gene_names <- gene_names[-1]
x1 <- x1[-1,-1]
# Not log-transformed TPMs.
exclude <- duplicated(gene_names)
keep_cells <- cell_names %in% ann[,2]
x1 <- x1[, keep_cells]
cell_names <- cell_names[keep_cells]
colnames(x1) <- cell_names;
reorder <- order(colnames(x1))
x1 <- x1[, reorder]

# Annotations
ann <- ann[ann[,2] %in% colnames(x1),]
ann <- ann[order(ann[,2]),]
keep_source <- as.character(unlist(ann[,4])) %in% "BA10"
x1 <- x1[, keep_source]
ann <- ann[ann[,2] %in% colnames(x1),]
ann <- ann[order(ann[,2]),]
SOURCE <- as.character(unlist(ann[,4]))
BATCH <- as.character(unlist(ann[,4]))
SOURCE[SOURCE=="BA10"] <- "Prefrontal cortex"
TYPE <- as.character(unlist(ann[3]))
AGE <- rep("51yo", times=length(BATCH))
SAMPLE <- colnames(x1)
SAMPLE <- paste0("X", SAMPLE)
DATA <- apply(x1, 1, as.numeric)
DATA <- t(DATA)
colnames(DATA) <- colnames(x1)
DATA <- DATA[!exclude, ]
rownames(DATA) <- gene_names[!exclude]
ANN <- data.frame(sample=SAMPLE, species=rep("Homo sapiens", times=length(TYPE)),
                  cell_type=TYPE, source=SOURCE, age=AGE, batch=BATCH)
rownames(ANN) <- colnames(x1)

write.table(
  DATA,
  file="../data/Lake-2016_Gene_TPM-PFC-pivot.dat",
  quote=FALSE, sep="\t", col.names=NA, row.names=TRUE
)
write.table(
  ANN,
  file="../data/Lake-2016_Gene_TPM_Sample-annotation-PFC-pivot.txt",
  quote=FALSE, sep="\t", col.names=TRUE, row.names=FALSE
)
```

# Conclusion

This concludes the methods used in this analysis.
Below we simply write the data to disk for exploration in `Final Results` at the top of this report.

```{r}
devtools::session_info()
```

# References
